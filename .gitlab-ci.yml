stages:
  - prepare
  - build
  - post build

build env:
  stage: prepare
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker build -f ci/Dockerfile.build -t $CI_REGISTRY_IMAGE/build ci/
    - docker push $CI_REGISTRY_IMAGE/build
  tags:
    - docker-host

build:
  stage: build
  image: $CI_REGISTRY_IMAGE/build
  before_script:
    - mkdir -p ccache
    - export CCACHE_BASEDIR=$CI_PROJECT_DIR
    - export CCACHE_DIR=$CI_PROJECT_DIR/ccache
  script:
    - mkdir build
    - cd build
    - cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache ..
    - make
    - make check
    - make package
  cache:
    paths:
      - ccache/
  artifacts:
    paths:
      - build/acoustid-index_*.deb
    expire_in: 7 days
  tags:
    - docker

docker image:
  stage: post build
  script:
    - mv build/acoustid-index_*.deb ci/
    - docker login -u $QUAY_USER -p $QUAY_PASSWORD quay.io
    - ./ci/build-image.sh
  tags:
    - docker-host
